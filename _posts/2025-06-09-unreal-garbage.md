---
title: 가비지 컬렉션
description: 가비지 컬렉션 시스템
author: gemini
date: YYYY-MM-DD HH:MM:SS +09:00
categories: [Unreal, part1]
tags: [garbage_collection]
math: true
mermaid: true
---

- 프로그램에서 더 이상 사용하지 않는 오브젝트를 자동으로 감지해 메모리를 회수하는 시스템
- 동적으로 생성된 모든 오브젝트 정보를 모아둔 저장소를 사용해 사용되지 않는 메모리를 추적
- 마크-스윕(Mark-Sweep) 방식의 가비지 컬렉션
	1. 저장소에서 최조 검색을 시작하는 루트 오브젝트를 표기한다
	2. 루트 오브젝트가 참조하는 객체를 찾아 마크(Mark)한다
	3. 마크된 객체로부터 다시 참조하는 개체를 찾아 마크하고 이를 계속 반복한다
	4.  이제 저장소에는 마크된 객체와 마크되지 않은 객체의 두 그룹으로 나뉜다
	5. 가비지 컬렉터가 저장소에서 마크되지 않은 객체(가비지)들의 메모리를 회수한다(Sweep) 

- ![가비지 컬렉션 시스템.png](/assets/img/posts/file_photos/가비지%20컬렉션%20시스템.png)

**언리얼 엔진의 가비지 컬렉션 시스템**
- 마크-스윕 방식의 가비지 컬렉션 시스템을 자체적으로 구축함
- 지정된 주기마다 몰아서 없애도록 설정되어 있음 (GCCycle. 기본값 60초)
- 성능 향상을 위해 병렬 처리, 클러스터링과 같은 기능을 탑재함


**가비지 컬렉션을 위한 객체 저장소**
- 관리되는 모든 언리얼 오브젝트의 정보를 저장하는 전역 변수 : **GUObjectArray**
- GUObjectArray의 각 요소에는 플래그(Flag)가 설정되어 있음
- 가비지 컬렉터가 참고하는 주요 플래그
	- Garbage 플래그 : 다른 언리얼 오브젝트로부터의 참조가 없어 회수 예정인 오브젝트 (*가비지 컬렉터의 메모리 회수*)
	- RootSet 플래그 : 다른 언리얼 오브젝트로부터 참조가 없어도 회수하않는 특별한 오브젝트 (*루트셋 플래그의 설정*)
	
- ![가비지 컬렉션을 위한 객체 저장소.png](/assets/img/posts/file_photos/가비지%20컬렉션을%20위한%20객체%20저장소.png)


**가비지 컬렉터의 메모리 회수**
- 가비지 컬렉터는 지정된 시간에 따라 주기적으로 메모리를 회수한다(기본값 60초)
- Garbage 플래그로 설정된 오브젝트를 파악하고 메모리를 안전하게 회수함
- Garbage 플래그는 수동으로 설정하는 것이 아닌, 시스템이 알아서 설정함
- ![가비지 컬렉터의 메모리 회수.png](/assets/img/posts/file_photos/가비지%20컬렉터의%20메모리%20회수.png)

**루트셋 플래그의 설정**
- AddToRoot 함수를 호출해 루트셋 플래그를 설정하면 최초 탐색 목록으로 설정됨
- 루트셋으로 설정된 언리얼 오브젝트는 메모리 회수로부터 보호받음
- RemoveFromRoot 함수를 호출해 루트셋 플래그를 제거할 수 있음
- ![루트셋 플래그의 설정.png](/assets/img/posts/file_photos/루트셋%20플래그의%20설정.png)

>콘텐츠 관련 오브젝트에 루트셋을 설정하는 방법은 권장되진 않음
{: .prompt-warning}